name: Build and Push Docker Image to Docker Hub

on:
  push:
    branches: [  "main" ]



jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Install Docker and Docker Compose
        run: |
          sudo apt-get update
          sudo apt-get install -y docker-compose


      - name: Build and push Docker images
        run: |
          docker-compose build
          echo "${{ secrets.DOCKERHUB_PASSWORD }}" | docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin
          docker-compose push

      - name: SSH into EC2 instance
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Install SSH client
        run: sudo apt-get install -y openssh-client

      - name: Create SSH directory
        run: mkdir -p ~/.ssh
      
      - name: Set permissions for SSH directory
        run: chmod 700 ~/.ssh
      
      - name: Create known_hosts file
        run: touch ~/.ssh/known_hosts
      
      - name: Set permissions for known_hosts file
        run: chmod 644 ~/.ssh/known_hosts
        
      - name: Retrieve host key and add to known_hosts
        run: |
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts
        
      - name: Pull Docker Compose images on EC2 instance
        run: |
            ssh -i ${{ secrets.SSH_PRIVATE_KEY }} ${{ secrets.EC2_USERNAME }}@${{ secrets.EC2_HOST }} "docker-compose pull"
        
      - name: Deploy Docker Compose on EC2 instance
        run: |
            ssh -i ${{ secrets.SSH_PRIVATE_KEY }} ${{ secrets.EC2_USERNAME }}@${{ secrets.EC2_HOST }} "docker-compose up -d"

        #  # Pull the Docker Hub images
        #  sudo docker pull hiransanjeewa/portfolio_client:latest
        #  sudo docker pull hiransanjeewa/portfolio_server:latest
        #  # Add more pull commands as needed
         
        
        #  # Start the containers
        
        #  sudo docker stop my-client-container
        #  sudo docker stop my-server-container
        #  sudo docker rm my-client-container
        #  sudo docker rm my-server-container
         


        #  sudo docker run -d -p 80:3000 --name=my-client-container hiransanjeewa/portfolio_client:latest

        #  sudo docker run -d -p 8080:8080 --name=my-server-container hiransanjeewa/portfolio_server:latest
        #  sudo docker image prune
        #  sudo docker container prune
        
        
          
    

   
         
         
       

